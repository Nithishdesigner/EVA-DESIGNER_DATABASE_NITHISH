<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EVA - Articles View</title>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- CSV Parser -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

    <style>
        :root {
            --primary: #2563eb;
            --bg-body: #F9FAFB;
            --border: #E5E7EB;
            --text-main: #111827;
            --text-gray: #6B7280;
            --danger: #ef4444;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Inter', sans-serif; }

        body {
            background-color: var(--bg-body);
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        /* --- SIDEBAR --- */
        aside {
            width: 290px;
            background: #ffffff;
            border-right: 1px solid var(--border);
            padding: 20px;
            display: flex;
            flex-direction: column;
            height: 100%;
            overflow-y: auto;
            flex-shrink: 0;
            z-index: 10;
        }

        .brand-logo {
            background-color: #ee3338;
            padding: 12px;
            border-radius: 4px;
            text-align: center;
            margin-bottom: 25px;
        }
        .brand-logo img { height: 32px; filter: brightness(0) invert(1); }

        .search-box {
            position: relative;
            margin-bottom: 20px;
        }
        .search-box input {
            width: 100%;
            padding: 10px 10px 10px 35px;
            border: 1px solid var(--border);
            border-radius: 6px;
            outline: none;
            font-size: 13px;
        }
        .search-box i {
            position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: #9CA3AF;
        }

        .filter-group { margin-bottom: 25px; border-bottom: 1px solid #f3f4f6; padding-bottom: 20px; }
        .filter-group:last-child { border-bottom: none; }
        .filter-title { font-size: 14px; font-weight: 700; margin-bottom: 12px; color: var(--text-main); }
        
        .checkbox-item {
            display: flex; align-items: center; gap: 8px; margin-bottom: 8px;
            font-size: 13px; color: var(--text-gray); cursor: pointer;
        }
        .checkbox-item input { accent-color: var(--primary); transform: scale(1.1); }

        /* Price Range Slider */
        .range-container { margin-top: 5px; }
        input[type=range] {
            width: 100%; cursor: pointer; accent-color: var(--primary);
        }
        .range-labels {
            display: flex; justify-content: space-between; font-size: 12px; color: var(--text-gray); margin-top: 5px;
        }
        .price-val { font-weight: 700; color: var(--primary); }

        .btn-apply {
            width: 100%; padding: 12px; background: var(--primary); color: white;
            border: none; border-radius: 6px; font-weight: 600; cursor: pointer; margin-top: auto;
        }
        .btn-apply:hover { background: #1e40af; }

        /* --- MAIN --- */
        main {
            flex: 1;
            padding: 30px;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
        }

        .page-header {
            display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;
        }
        .page-header h2 { font-size: 22px; font-weight: 700; }
        .page-header span { color: var(--text-gray); font-size: 14px; font-weight: 400; margin-left: 10px; }

        /* Grid */
        .articles-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            flex: 1; 
            align-content: start;
        }

        /* Card */
        .card {
            background: white; border: 1px solid var(--border); border-radius: 12px;
            padding: 16px; position: relative; transition: box-shadow 0.2s;
            display: flex; flex-direction: column;
        }
        .card:hover { box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }

        .card-actions {
            display: flex; justify-content: space-between; position: absolute; top: 16px; left: 16px; right: 16px; z-index: 2;
        }
        .action-icon {
            width: 32px; height: 32px; background: white; border: 1px solid var(--border);
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            color: var(--text-gray); cursor: pointer; transition: 0.2s;
        }
        .action-icon:hover { transform: scale(1.1); }
        .action-icon.like-btn:hover { color: var(--danger); border-color: var(--danger); }
        .action-icon.comp-btn:hover { color: var(--primary); border-color: var(--primary); }
        
        /* Active states indicating already added */
        .action-icon.added-fav { background: #fef2f2; color: var(--danger); border-color: var(--danger); }
        .action-icon.added-comp { background: #eff6ff; color: var(--primary); border-color: var(--primary); }

        .img-wrap {
            height: 200px; display: flex; align-items: center; justify-content: center;
            margin: 25px 0 15px 0;
        }
        .img-wrap img { max-width: 100%; max-height: 100%; object-fit: contain; }

        .card-label { font-size: 11px; font-weight: 700; color: #111; margin-bottom: 2px; text-transform: uppercase; }
        .card-title { font-size: 18px; font-weight: 700; color: var(--primary); margin-bottom: 15px; }

        .spec { display: flex; font-size: 13px; margin-bottom: 6px; }
        .spec-lbl { width: 80px; color: var(--text-main); font-weight: 600; }
        .spec-val { color: var(--text-gray); flex: 1; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; }

        /* Pagination */
        .pagination {
            display: flex; justify-content: center; gap: 8px; margin-top: 30px; padding-top: 20px;
            border-top: 1px solid var(--border);
        }
        .page-btn {
            width: 36px; height: 36px; display: flex; align-items: center; justify-content: center;
            border: 1px solid var(--border); border-radius: 6px; cursor: pointer;
            font-size: 14px; color: var(--text-gray); background: white;
        }
        .page-btn.active { background: var(--primary); color: white; border-color: var(--primary); }
        .page-btn:hover:not(.active) { background: #f3f4f6; }
        .page-btn.disabled { opacity: 0.5; cursor: not-allowed; }

        #loader { text-align: center; margin-top: 100px; font-weight: 600; color: var(--primary); font-size: 18px; }
        .error-msg { text-align: center; margin-top: 50px; color: #dc2626; background: #fee2e2; padding: 20px; border-radius: 8px; }

        /* Mobile Responsive */
        @media(max-width: 1024px) {
            .articles-grid { grid-template-columns: repeat(2, 1fr); }
        }
        @media(max-width: 768px) {
            body { flex-direction: column; overflow: auto; }
            aside { width: 100%; height: auto; overflow: visible; }
            main { overflow: visible; }
            .articles-grid { grid-template-columns: 1fr; }
        }

    </style>
</head>
<body>

    <aside>
        <div class="brand-logo"><img src="https://walkaroo.in/images/logo.png" alt="Walkaroo"></div>
        
        <h3>Advanced Search</h3>
        <br>
        
        <!-- Search -->
        <div class="filter-group">
            <div class="filter-title">Search Articles</div>
            <div class="search-box" style="margin-bottom:0">
                <i class="fa-solid fa-magnifying-glass"></i>
                <input type="text" id="searchInput" placeholder="Search by title..." onkeyup="applyFilters()">
            </div>
        </div>

        <!-- Categories -->
        <div class="filter-group">
            <div class="filter-title">Category</div>
            <label class="checkbox-item"><input type="checkbox" class="cat-filter" value="BOYS"> Boys</label>
            <label class="checkbox-item"><input type="checkbox" class="cat-filter" value="GIRLS"> Girls</label>
            <label class="checkbox-item"><input type="checkbox" class="cat-filter" value="KIDS"> Kids</label>
            <label class="checkbox-item"><input type="checkbox" class="cat-filter" value="GENTS"> Gents</label>
            <label class="checkbox-item"><input type="checkbox" class="cat-filter" value="LADIES"> Ladies</label>
            <label class="checkbox-item"><input type="checkbox" class="cat-filter" value="GAINTS"> Gents Giants</label>
        </div>

        <!-- Price Range Filter -->
        <div class="filter-group">
            <div class="filter-title">Price Range: <span class="price-val" id="priceLabel">₹3000</span></div>
            <div class="range-container">
                <input type="range" id="priceRange" min="0" max="3000" value="3000" oninput="updatePriceLabel(this.value)">
                <div class="range-labels">
                    <span>₹0</span>
                    <span>₹3000+</span>
                </div>
            </div>
        </div>

        <button class="btn-apply" onclick="applyFilters()">Apply Filters</button>
    </aside>

    <main>
        <div class="page-header">
            <div>
                <h2>Articles <span id="items-count">...</span></h2>
            </div>
            <div>
                <select id="sortSelect" style="padding:8px; border-radius:6px; border:1px solid #ddd;" onchange="applyFilters()">
                    <option value="newest">Sort by: Latest</option>
                    <option value="price-low">Price: Low to High</option>
                    <option value="price-high">Price: High to Low</option>
                </select>
            </div>
        </div>

        <div id="loader">
            <i class="fa-solid fa-spinner fa-spin"></i> Fetching Data...<br>
            <span style="font-size:12px; font-weight:400; color:#666">Connecting to Google Sheets...</span>
        </div>
        <div class="articles-grid" id="article-grid"></div>

        <div class="pagination" id="pagination"></div>
    </main>

    <script>
        // --- CONFIG ---
        const SHEET_ID = '1JOJ7JwkDJbCpZ3NWpnsYQm1kDi2XUijyfhQ937x0NNw';
        
        // URLs for the two sheets
        const URL_MASTER = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=MASTER`;
        const URL_DL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=DL`;

        // State Variables
        let rawData = [];      // Combined data
        let imageMap = {};     // Map Article -> DriveLink
        let filteredData = []; // Data after search/filter
        
        let currentPage = 1;
        const itemsPerPage = 9;
        
        // LocalStorage for Fav/Compare
        let likedItems = JSON.parse(localStorage.getItem('eva_liked')) || [];
        let compareItems = JSON.parse(localStorage.getItem('eva_compare')) || [];

        // --- INITIALIZATION ---
        init();

        async function init() {
            try {
                // Fetch both sheets simultaneously
                const [masterRes, dlRes] = await Promise.all([
                    fetchCsv(URL_MASTER),
                    fetchCsv(URL_DL)
                ]);

                // 1. Process DL Sheet first to build Image Map
                processDL(dlRes.data);

                // 2. Process MASTER Sheet and link images
                processMaster(masterRes.data);

            } catch (error) {
                console.error(error);
                showError("Failed to load data. Please check internet or Sheet permissions.");
            }
        }

        // Helper to fetch CSV
        function fetchCsv(url) {
            return new Promise((resolve, reject) => {
                Papa.parse(url, {
                    download: true,
                    header: false,
                    skipEmptyLines: true,
                    complete: resolve,
                    error: reject
                });
            });
        }

        function showError(msg) {
            document.getElementById('loader').innerHTML = `<div class="error-msg">${msg}</div>`;
        }

        // --- DATA PROCESSING ---

        function processDL(rows) {
            // Rows[0] is header.
            // DL Sheet Spec: Col B (Index 1) = Article Name, Col G (Index 6) = Drive Link
            const dataRows = rows.slice(1);
            
            dataRows.forEach(row => {
                const articleName = row[1]; // Col B
                const link = row[6];        // Col G
                
                if(articleName && link) {
                    imageMap[articleName.trim()] = link;
                }
            });
        }

        function processMaster(rows) {
            const dataRows = rows.slice(1);

            // MASTER Sheet Spec:
            // C (Index 2) = Article
            // V-Y (21-24) = Sizes
            // AA-AD (26-29) = MRP
            // AF (31) = Features
            // AH-AM (33-38) = Categories

            rawData = dataRows.map(row => {
                if(!row[2]) return null; // Skip if no article name

                const articleName = row[2].trim();

                // 1. Categories
                let cats = [];
                if(checkBool(row[33])) cats.push('BOYS');
                if(checkBool(row[34])) cats.push('GIRLS');
                if(checkBool(row[35])) cats.push('KIDS');
                if(checkBool(row[36])) cats.push('GENTS');
                if(checkBool(row[37])) cats.push('LADIES');
                if(checkBool(row[38])) cats.push('GAINTS');

                // 2. Sizes
                let sizes = [];
                for(let i=21; i<=24; i++) if(row[i]) sizes.push(row[i]);
                let sizeStr = sizes.join(', ') || 'Standard';

                // 3. Price (min of cols 26-29)
                let prices = [];
                for(let i=26; i<=29; i++) {
                    let p = parseFloat(row[i]);
                    if(!isNaN(p) && p > 0) prices.push(p);
                }
                let minPrice = prices.length > 0 ? Math.min(...prices) : 0;

                // 4. Image Linking from DL Map
                let imgLink = imageMap[articleName] || "";
                
                return {
                    id: articleName, 
                    name: articleName,
                    features: row[31] || 'Standard',
                    categories: cats,
                    size: sizeStr,
                    price: minPrice,
                    image: imgLink
                };
            }).filter(item => item !== null);

            applyFilters();
        }

        function checkBool(val) {
            return val && (val.toLowerCase() === 'true' || val.length > 0);
        }

        // --- FILTERING ---

        function updatePriceLabel(val) {
            document.getElementById('priceLabel').innerText = `₹${val}`;
            applyFilters();
        }

        function applyFilters() {
            const search = document.getElementById('searchInput').value.toLowerCase();
            const checkedCats = Array.from(document.querySelectorAll('.cat-filter:checked')).map(cb => cb.value);
            const sortMode = document.getElementById('sortSelect').value;
            const maxPrice = parseFloat(document.getElementById('priceRange').value);

            let temp = rawData.filter(item => {
                const matchSearch = item.name.toLowerCase().includes(search) || item.features.toLowerCase().includes(search);
                
                let matchCat = true;
                if(checkedCats.length > 0) {
                    matchCat = checkedCats.some(c => item.categories.includes(c));
                }

                let matchPrice = true;
                if (maxPrice < 3000) {
                    matchPrice = item.price <= maxPrice;
                }

                return matchSearch && matchCat && matchPrice;
            });

            // Sorting
            if(sortMode === 'price-low') temp.sort((a,b) => a.price - b.price);
            if(sortMode === 'price-high') temp.sort((a,b) => b.price - a.price);
            if(sortMode === 'newest') temp.reverse();

            filteredData = temp;
            currentPage = 1;
            renderPage();
        }

        // --- RENDERING ---

        function renderPage() {
            document.getElementById('loader').style.display = 'none';
            const grid = document.getElementById('article-grid');
            const countLabel = document.getElementById('items-count');
            const pagination = document.getElementById('pagination');

            countLabel.innerText = `${filteredData.length} items found`;
            grid.innerHTML = '';
            pagination.innerHTML = '';

            if(filteredData.length === 0) {
                grid.innerHTML = '<div style="grid-column:1/-1; text-align:center; padding:50px; color:#888;">No articles match your filters.</div>';
                return;
            }

            const start = (currentPage - 1) * itemsPerPage;
            const end = start + itemsPerPage;
            const pageItems = filteredData.slice(start, end);

            pageItems.forEach(item => {
                // Convert Drive Link to Fast Direct Link
                let imgHtml = `<span style="color:#ccc; font-size:12px">No Image</span>`;
                
                if(item.image) {
                    const idMatch = item.image.match(/[-\w]{25,}/);
                    if(idMatch) {
                        const fileId = idMatch[0];
                        const fastUrl = `https://lh3.googleusercontent.com/d/${fileId}=w400`;
                        imgHtml = `<img src="${fastUrl}" alt="${item.name}" loading="lazy" onerror="this.parentElement.innerHTML='<span style=\'color:#ccc\'>Img Error</span>'">`;
                    }
                }

                // Check active states
                const isFav = likedItems.includes(item.id);
                const isComp = compareItems.includes(item.id);

                const html = `
                    <div class="card">
                        <div class="card-actions">
                            <div class="action-icon like-btn ${isFav ? 'added-fav' : ''}" 
                                 onclick="copyToFav('${item.id}', this)" 
                                 title="Copy to FAV.html">
                                 <i class="${isFav ? 'fa-solid' : 'fa-regular'} fa-heart"></i>
                            </div>
                            <div class="action-icon comp-btn ${isComp ? 'added-comp' : ''}" 
                                 onclick="copyToComp('${item.id}', this)" 
                                 title="Copy to comp.html">
                                 <i class="fa-solid fa-code-compare"></i>
                            </div>
                        </div>
                        <div class="img-wrap">${imgHtml}</div>
                        <div class="card-label">Article Number</div>
                        <div class="card-title">${item.name}</div>
                        <div class="spec"><div class="spec-lbl">Size :</div><div class="spec-val">${item.size}</div></div>
                        <div class="spec"><div class="spec-lbl">Category :</div><div class="spec-val">${item.categories.join(', ') || 'N/A'}</div></div>
                        <div class="spec"><div class="spec-lbl">MRP :</div><div class="spec-val" style="color:#2563eb; font-weight:700;">₹${item.price}</div></div>
                        <div class="spec"><div class="spec-lbl">Features :</div><div class="spec-val">${item.features}</div></div>
                    </div>
                `;
                grid.innerHTML += html;
            });

            // Pagination UI
            const totalPages = Math.ceil(filteredData.length / itemsPerPage);
            if(totalPages > 1) {
                pagination.innerHTML += `<div class="page-btn ${currentPage===1?'disabled':''}" onclick="changePage(${currentPage-1})"><i class="fa-solid fa-chevron-left"></i></div>`;
                for(let i=1; i<=totalPages; i++) {
                    if(i === 1 || i === totalPages || (i >= currentPage-1 && i <= currentPage+1)) {
                        pagination.innerHTML += `<div class="page-btn ${i===currentPage?'active':''}" onclick="changePage(${i})">${i}</div>`;
                    } else if (i === currentPage-2 || i === currentPage+2) {
                        pagination.innerHTML += `<span>...</span>`;
                    }
                }
                pagination.innerHTML += `<div class="page-btn ${currentPage===totalPages?'disabled':''}" onclick="changePage(${currentPage+1})"><i class="fa-solid fa-chevron-right"></i></div>`;
            }
        }

        function changePage(page) {
            const totalPages = Math.ceil(filteredData.length / itemsPerPage);
            if(page < 1 || page > totalPages) return;
            currentPage = page;
            renderPage();
            document.querySelector('main').scrollTo(0,0);
        }

        // --- COPY LOGIC (FAV / COMP) ---

        function copyToFav(id, btnElement) {
            // Logic: Toggle presence in localStorage 'eva_liked'
            if(likedItems.includes(id)) {
                // Remove
                likedItems = likedItems.filter(i => i !== id);
                btnElement.classList.remove('added-fav');
                btnElement.querySelector('i').classList.replace('fa-solid', 'fa-regular');
            } else {
                // Add
                likedItems.push(id);
                btnElement.classList.add('added-fav');
                btnElement.querySelector('i').classList.replace('fa-regular', 'fa-solid');
                alert("Article copied to FAV.html list!");
            }
            localStorage.setItem('eva_liked', JSON.stringify(likedItems));
        }

        function copyToComp(id, btnElement) {
            // Logic: Toggle presence in localStorage 'eva_compare'
            if(compareItems.includes(id)) {
                // Remove
                compareItems = compareItems.filter(i => i !== id);
                btnElement.classList.remove('added-comp');
            } else {
                // Add
                compareItems.push(id);
                btnElement.classList.add('added-comp');
                alert("Article copied to comp.html list!");
            }
            localStorage.setItem('eva_compare', JSON.stringify(compareItems));
        }

    </script>
</body>
</html>