<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EVA - Liked Articles</title>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- CSV Parser -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

    <style>
        :root {
            --primary: #2563eb;
            --bg-body: #F9FAFB;
            --border: #E5E7EB;
            --text-main: #111827;
            --text-gray: #6B7280;
            --danger: #ef4444;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Inter', sans-serif; }

        body {
            background-color: var(--bg-body);
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        /* --- SIDEBAR --- */
        aside {
            width: 290px;
            background: #ffffff;
            border-right: 1px solid var(--border);
            padding: 20px;
            display: flex;
            flex-direction: column;
            height: 100%;
            overflow-y: auto;
            flex-shrink: 0;
            z-index: 10;
        }

        .brand-logo {
            background-color: #ee3338;
            padding: 12px;
            border-radius: 4px;
            text-align: center;
            margin-bottom: 25px;
        }
        .brand-logo img { height: 32px; filter: brightness(0) invert(1); }

        .search-box {
            position: relative;
            margin-bottom: 20px;
        }
        .search-box input {
            width: 100%;
            padding: 10px 10px 10px 35px;
            border: 1px solid var(--border);
            border-radius: 6px;
            outline: none;
            font-size: 13px;
        }
        .search-box i {
            position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: #9CA3AF;
        }

        .filter-group { margin-bottom: 25px; border-bottom: 1px solid #f3f4f6; padding-bottom: 20px; }
        .filter-group:last-child { border-bottom: none; }
        .filter-title { font-size: 14px; font-weight: 700; margin-bottom: 12px; color: var(--text-main); }
        
        .checkbox-item {
            display: flex; align-items: center; gap: 8px; margin-bottom: 8px;
            font-size: 13px; color: var(--text-gray); cursor: pointer;
        }
        .checkbox-item input { accent-color: var(--primary); transform: scale(1.1); }

        /* Price Range Slider */
        .range-container { margin-top: 5px; }
        input[type=range] { width: 100%; cursor: pointer; accent-color: var(--primary); }
        .range-labels {
            display: flex; justify-content: space-between; font-size: 12px; color: var(--text-gray); margin-top: 5px;
        }
        .price-val { font-weight: 700; color: var(--primary); }

        .btn-apply {
            width: 100%; padding: 12px; background: var(--primary); color: white;
            border: none; border-radius: 6px; font-weight: 600; cursor: pointer; margin-top: auto;
        }
        .btn-apply:hover { background: #1e40af; }

        /* --- MAIN --- */
        main {
            flex: 1;
            padding: 30px;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
        }

        .page-header {
            display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;
        }
        .page-header h2 { font-size: 22px; font-weight: 700; display:flex; align-items:center; gap:10px; }
        .page-header span { color: var(--text-gray); font-size: 14px; font-weight: 400; margin-left: 10px; }

        /* Back Button */
        .btn-back {
            text-decoration: none; font-size: 14px; color: var(--text-gray); display:flex; align-items:center; gap:5px;
            margin-bottom: 10px; font-weight: 500;
        }
        .btn-back:hover { color: var(--primary); }

        /* Grid */
        .articles-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            flex: 1; 
            align-content: start;
        }

        /* Card */
        .card {
            background: white; border: 1px solid var(--border); border-radius: 12px;
            padding: 16px; position: relative; transition: box-shadow 0.2s;
            display: flex; flex-direction: column;
        }
        .card:hover { box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }

        .card-actions {
            display: flex; justify-content: space-between; position: absolute; top: 16px; left: 16px; right: 16px; z-index: 2;
        }
        .action-icon {
            width: 32px; height: 32px; background: white; border: 1px solid var(--border);
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            color: var(--text-gray); cursor: pointer; transition: 0.2s;
        }
        /* Liked State */
        .action-icon.liked { color: var(--danger); border-color: var(--danger); background: #fef2f2; }
        .action-icon:hover { transform: scale(1.1); }

        .img-wrap {
            height: 200px; display: flex; align-items: center; justify-content: center;
            margin: 25px 0 15px 0;
        }
        .img-wrap img { max-width: 100%; max-height: 100%; object-fit: contain; }

        .card-label { font-size: 11px; font-weight: 700; color: #111; margin-bottom: 2px; text-transform: uppercase; }
        .card-title { font-size: 18px; font-weight: 700; color: var(--primary); margin-bottom: 15px; }

        .spec { display: flex; font-size: 13px; margin-bottom: 6px; }
        .spec-lbl { width: 80px; color: var(--text-main); font-weight: 600; }
        .spec-val { color: var(--text-gray); flex: 1; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; }

        /* Pagination */
        .pagination {
            display: flex; justify-content: center; gap: 8px; margin-top: 30px; padding-top: 20px;
            border-top: 1px solid var(--border);
        }
        .page-btn {
            width: 36px; height: 36px; display: flex; align-items: center; justify-content: center;
            border: 1px solid var(--border); border-radius: 6px; cursor: pointer;
            font-size: 14px; color: var(--text-gray); background: white;
        }
        .page-btn.active { background: var(--primary); color: white; border-color: var(--primary); }
        .page-btn:hover:not(.active) { background: #f3f4f6; }
        .page-btn.disabled { opacity: 0.5; cursor: not-allowed; }

        #loader { text-align: center; margin-top: 100px; font-weight: 600; color: var(--primary); font-size: 18px; }
        .empty-state {
            grid-column: 1 / -1; text-align: center; padding: 60px; color: var(--text-gray);
        }
        .empty-state i { font-size: 40px; margin-bottom: 15px; color: #d1d5db; }

    </style>
</head>
<body>

    <aside>
        <div class="brand-logo"><img src="https://walkaroo.in/images/logo.png" alt="Walkaroo"></div>
        
        <h3>Liked Items</h3>
        <br>
        
        <!-- Search -->
        <div class="filter-group">
            <div class="filter-title">Search Favourites</div>
            <div class="search-box" style="margin-bottom:0">
                <i class="fa-solid fa-magnifying-glass"></i>
                <input type="text" id="searchInput" placeholder="Search by title..." onkeyup="applyFilters()">
            </div>
        </div>

        <!-- Categories -->
        <div class="filter-group">
            <div class="filter-title">Category</div>
            <label class="checkbox-item"><input type="checkbox" class="cat-filter" value="BOYS"> Boys</label>
            <label class="checkbox-item"><input type="checkbox" class="cat-filter" value="GIRLS"> Girls</label>
            <label class="checkbox-item"><input type="checkbox" class="cat-filter" value="KIDS"> Kids</label>
            <label class="checkbox-item"><input type="checkbox" class="cat-filter" value="GENTS"> Gents</label>
            <label class="checkbox-item"><input type="checkbox" class="cat-filter" value="LADIES"> Ladies</label>
            <label class="checkbox-item"><input type="checkbox" class="cat-filter" value="GAINTS"> Gents Giants</label>
        </div>

        <!-- Price Range Filter -->
        <div class="filter-group">
            <div class="filter-title">Price Range: <span class="price-val" id="priceLabel">₹3000</span></div>
            <div class="range-container">
                <input type="range" id="priceRange" min="0" max="3000" value="3000" oninput="updatePriceLabel(this.value)">
                <div class="range-labels">
                    <span>₹0</span>
                    <span>₹3000+</span>
                </div>
            </div>
        </div>

        <button class="btn-apply" onclick="applyFilters()">Apply Filters</button>
    </aside>

    <main>
        <a href="articles.html" class="btn-back"><i class="fa-solid fa-arrow-left"></i> Back to All Articles</a>
        
        <div class="page-header">
            <div>
                <h2><i class="fa-solid fa-heart" style="color:var(--danger)"></i> Liked Articles <span id="items-count">...</span></h2>
            </div>
            <div>
                <select id="sortSelect" style="padding:8px; border-radius:6px; border:1px solid #ddd;" onchange="applyFilters()">
                    <option value="newest">Sort by: Latest Added</option>
                    <option value="price-low">Price: Low to High</option>
                    <option value="price-high">Price: High to Low</option>
                </select>
            </div>
        </div>

        <div id="loader"><i class="fa-solid fa-spinner fa-spin"></i> Syncing Liked Data...</div>
        <div class="articles-grid" id="article-grid"></div>

        <div class="pagination" id="pagination"></div>
    </main>

    <script>
        // CONFIG
        const SHEET_ID = '1JOJ7JwkDJbCpZ3NWpnsYQm1kDi2XUijyfhQ937x0NNw';
        const SHEET_NAME = 'MASTER'; 
        const CSV_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${SHEET_NAME}`;

        let rawData = [];
        let filteredData = [];
        let likedIds = [];
        let currentPage = 1;
        const itemsPerPage = 9;

        // Load Liked IDs from Local Storage immediately
        likedIds = JSON.parse(localStorage.getItem('likedArticles')) || [];

        // Fetch Master Data (We need this to show images/prices even for liked items)
        Papa.parse(CSV_URL, {
            download: true,
            header: false, 
            skipEmptyLines: true,
            complete: function(results) {
                if(results.data.length === 0) {
                    alert("No Data in Sheet");
                    return;
                }
                processData(results.data);
            },
            error: function(err) {
                document.getElementById('loader').innerText = "Connection Failed. Check Internet.";
            }
        });

        function processData(rows) {
            const headers = rows[0]; 
            const dataRows = rows.slice(1); 

            // Column Mapping (Same as Articles Page)
            const getIdx = (name) => headers.findIndex(h => h && h.toString().toLowerCase().trim() === name.toLowerCase());

            const idxArticle = getIdx('ARTICLE') > -1 ? getIdx('ARTICLE') : 2;
            const idxFeatures = getIdx('FEATURES') > -1 ? getIdx('FEATURES') : 31;
            const idxDrive = getIdx('Drive Link') > -1 ? getIdx('Drive Link') : -1;
            const idxBoys = 33; const idxGirls = 34; const idxKids = 35;
            const idxGents = 36; const idxLadies = 37; const idxGiants = 38;

            // Map all data
            const allItems = dataRows.map(row => {
                if(!row[idxArticle]) return null;

                // Categories
                let cats = [];
                const checkCat = (idx, name) => {
                    if(row[idx] && (row[idx].toLowerCase() === 'true' || row[idx].length > 0)) cats.push(name);
                };
                checkCat(idxBoys, 'BOYS'); checkCat(idxGirls, 'GIRLS'); checkCat(idxKids, 'KIDS');
                checkCat(idxGents, 'GENTS'); checkCat(idxLadies, 'LADIES'); checkCat(idxGiants, 'GAINTS');

                // Sizes
                let sizes = [];
                for(let i=21; i<=24; i++) { if(row[i]) sizes.push(row[i]); }
                
                // Price
                let prices = [];
                for(let i=26; i<=29; i++) {
                    let p = parseFloat(row[i]);
                    if(!isNaN(p) && p > 0) prices.push(p);
                }
                let minPrice = prices.length > 0 ? Math.min(...prices) : 0;

                // Image
                let imgLink = "";
                if(idxDrive > -1 && row[idxDrive]) imgLink = row[idxDrive];
                else {
                    let found = row.find(c => c && c.toString().includes('drive.google.com'));
                    if(found) imgLink = found;
                }

                return {
                    id: row[idxArticle], // Using Article Name as ID
                    name: row[idxArticle],
                    features: row[idxFeatures] || 'Standard',
                    categories: cats, 
                    price: minPrice,
                    image: imgLink,
                    size: sizes.join(', ') || '08 x 12'
                };
            }).filter(item => item !== null);

            // KEY STEP: Filter ONLY items that are in the Liked List
            // We match based on Article Name (ID)
            rawData = allItems.filter(item => likedIds.includes(item.id));

            applyFilters();
        }

        function updatePriceLabel(val) {
            document.getElementById('priceLabel').innerText = `₹${val}`;
            applyFilters();
        }

        function applyFilters() {
            const search = document.getElementById('searchInput').value.toLowerCase();
            const checkedCats = Array.from(document.querySelectorAll('.cat-filter:checked')).map(cb => cb.value);
            const sortMode = document.getElementById('sortSelect').value;
            const maxPrice = parseFloat(document.getElementById('priceRange').value);

            filteredData = rawData.filter(item => {
                const matchSearch = item.name.toLowerCase().includes(search) || item.features.toLowerCase().includes(search);
                
                let matchCat = true;
                if(checkedCats.length > 0) {
                    matchCat = checkedCats.some(c => item.categories.includes(c));
                }

                let matchPrice = true;
                if (maxPrice < 3000) { matchPrice = item.price <= maxPrice; }

                return matchSearch && matchCat && matchPrice;
            });

            // Sorting
            if(sortMode === 'price-low') filteredData.sort((a,b) => a.price - b.price);
            if(sortMode === 'price-high') filteredData.sort((a,b) => b.price - a.price);
            if(sortMode === 'newest') filteredData.reverse();

            currentPage = 1;
            renderPage();
        }

        function renderPage() {
            document.getElementById('loader').style.display = 'none';
            const grid = document.getElementById('article-grid');
            const countLabel = document.getElementById('items-count');
            const pagination = document.getElementById('pagination');

            countLabel.innerText = `${filteredData.length} items`;
            grid.innerHTML = '';
            pagination.innerHTML = '';

            if(filteredData.length === 0) {
                if(rawData.length === 0) {
                    grid.innerHTML = `
                        <div class="empty-state">
                            <i class="fa-regular fa-heart"></i>
                            <h3>No Liked Articles Yet</h3>
                            <p>Go to the articles page and click the heart icon to add items here.</p>
                            <br>
                            <a href="articles.html" class="btn-apply" style="display:inline-block; width:auto; padding:10px 20px; text-decoration:none;">Browse Articles</a>
                        </div>`;
                } else {
                    grid.innerHTML = '<div class="empty-state">No liked items match your search filters.</div>';
                }
                return;
            }

            const start = (currentPage - 1) * itemsPerPage;
            const end = start + itemsPerPage;
            const pageItems = filteredData.slice(start, end);

            pageItems.forEach(item => {
                let imgUrl = "";
                if(item.image && item.image.includes('drive.google.com')) {
                    const idMatch = item.image.match(/[-\w]{25,}/);
                    if(idMatch) imgUrl = `https://lh3.googleusercontent.com/d/${idMatch[0]}=w400`;
                }

                const imgHtml = imgUrl 
                    ? `<img src="${imgUrl}" alt="${item.name}" onerror="this.parentElement.innerHTML='<span style=\'color:#ccc\'>No Image</span>'">` 
                    : `<span style="color:#ccc">No Image</span>`;

                const html = `
                    <div class="card">
                        <div class="card-actions">
                            <!-- Solid Red Heart for Liked Page -->
                            <div class="action-icon liked" onclick="removeLike('${item.id}')" title="Remove from Favourites">
                                <i class="fa-solid fa-heart"></i>
                            </div>
                            <div class="action-icon" title="Compare"><i class="fa-solid fa-code-compare"></i></div>
                        </div>
                        <div class="img-wrap">${imgHtml}</div>
                        <div class="card-label">Article Number</div>
                        <div class="card-title">${item.name}</div>
                        <div class="spec"><div class="spec-lbl">Size :</div><div class="spec-val">${item.size}</div></div>
                        <div class="spec"><div class="spec-lbl">Category :</div><div class="spec-val">${item.categories.join(', ') || 'N/A'}</div></div>
                        <div class="spec"><div class="spec-lbl">MRP :</div><div class="spec-val" style="color:#2563eb; font-weight:700;">₹${item.price}</div></div>
                        <div class="spec"><div class="spec-lbl">Features :</div><div class="spec-val">${item.features}</div></div>
                    </div>
                `;
                grid.innerHTML += html;
            });

            // Pagination UI
            const totalPages = Math.ceil(filteredData.length / itemsPerPage);
            if(totalPages > 1) {
                pagination.innerHTML += `<div class="page-btn ${currentPage===1?'disabled':''}" onclick="changePage(${currentPage-1})"><i class="fa-solid fa-chevron-left"></i></div>`;
                for(let i=1; i<=totalPages; i++) {
                    if(i === 1 || i === totalPages || (i >= currentPage-1 && i <= currentPage+1)) {
                        pagination.innerHTML += `<div class="page-btn ${i===currentPage?'active':''}" onclick="changePage(${i})">${i}</div>`;
                    } else if (i === currentPage-2 || i === currentPage+2) pagination.innerHTML += `<span>...</span>`;
                }
                pagination.innerHTML += `<div class="page-btn ${currentPage===totalPages?'disabled':''}" onclick="changePage(${currentPage+1})"><i class="fa-solid fa-chevron-right"></i></div>`;
            }
        }

        // Remove Function
        function removeLike(id) {
            if(confirm("Remove this article from favourites?")) {
                // Update Local Storage
                likedIds = likedIds.filter(lid => lid !== id);
                localStorage.setItem('likedArticles', JSON.stringify(likedIds));
                
                // Update Raw Data (Remove from current view)
                rawData = rawData.filter(item => item.id !== id);
                
                // Re-Filter & Render
                applyFilters();
            }
        }

        function changePage(page) {
            const totalPages = Math.ceil(filteredData.length / itemsPerPage);
            if(page < 1 || page > totalPages) return;
            currentPage = page;
            renderPage();
            document.querySelector('main').scrollTo(0,0);
        }

    </script>
</body>
</html>